# 現地調査報告業務DXシステム - コーディング規約

**版数**: 1.0
**作成日**: 2025年10月16日
**対象**: 株式会社グラフデポ様
**作成元**: 株式会社ミオシステム

---

## 1. 全般的な原則

### 1.1 基本方針

```
✅ 可読性: コードは書く時間より読む時間の方が長い - 読みやすさを最優先
✅ 一貫性: プロジェクト全体で統一されたスタイル
✅ シンプル: 複雑な実装より、シンプルで明確な実装
✅ 保守性: 将来の変更・拡張を考慮した設計
```

### 1.2 言語・フレームワーク

| 用途 | 技術スタック |
|------|-------------|
| スマホアプリ (iOS/Android) | React Native + TypeScript |
| Webフロントエンド | React + TypeScript |
| バックエンドAPI | Node.js + Express + TypeScript |
| データベース | PostgreSQL |
| クラウドストレージ | AWS S3 / Google Cloud Storage |
| 地図 | Google Maps API / OpenStreetMap |

---

## 2. TypeScript / JavaScript コーディング規約

### 2.1 基本ルール

#### 命名規則

```typescript
// ✅ 良い例
// クラス名: PascalCase
class UserService {}
class PhotoManager {}

// 関数名・変数名: camelCase
function getUserById() {}
const projectList = [];

// 定数: UPPER_SNAKE_CASE
const API_BASE_URL = 'https://api.example.com';
const MAX_PHOTO_SIZE = 5 * 1024 * 1024; // 5MB

// コンポーネント名: PascalCase
function PhotoGallery() {}
const MapView = () => {};

// 型・インターフェース: PascalCase
interface User {
  id: string;
  name: string;
}

type ProjectStatus = 'pending' | 'in_progress' | 'completed';

// プライベートメンバー: アンダースコアプレフィックス
class PhotoService {
  private _cache: Map<string, Photo>;
}

// ❌ 悪い例
class photo_service {}  // クラス名は PascalCase
const UserList = [];    // 変数名は camelCase
function get_user() {}  // 関数名は camelCase
```

#### ファイル名規則

```
// コンポーネント: PascalCase
PhotoGallery.tsx
MapView.tsx

// ユーティリティ・サービス: camelCase
photoService.ts
dateFormatter.ts

// 型定義: camelCase + .types.ts
photo.types.ts
project.types.ts

// 定数: camelCase + .constants.ts
api.constants.ts
colors.constants.ts
```

### 2.2 型定義

```typescript
// ✅ 明示的な型定義を使用
function getProjectById(id: string): Project | null {
  // ...
}

// ✅ インターフェースで構造を定義
interface Photo {
  id: string;
  projectId: string;
  filePath: string;
  latitude: number;
  longitude: number;
  direction: number; // 0-360
  takenAt: Date;
}

// ✅ Union Typeで選択肢を制限
type ProjectStatus = 'pending' | 'in_progress' | 'completed' | 'approved';

// ✅ Genericsを活用
function fetchData<T>(url: string): Promise<T> {
  // ...
}

// ❌ any型の使用は避ける
function processData(data: any) {  // 避ける
  // ...
}

// ✅ 不明な型は unknown を使う
function processData(data: unknown) {
  if (typeof data === 'object' && data !== null) {
    // 型ガードで型を絞り込む
  }
}
```

### 2.3 関数・メソッド

```typescript
// ✅ 単一責任の原則: 1つの関数は1つのことだけをする
// 良い例
function validateEmail(email: string): boolean {
  const regex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return regex.test(email);
}

function sendEmail(to: string, subject: string, body: string): Promise<void> {
  // メール送信処理
}

// ❌ 悪い例: 複数の責任を持つ
function validateAndSendEmail(email: string, subject: string, body: string) {
  // バリデーションと送信を1つの関数でやらない
}

// ✅ 引数は3つまで (それ以上はオブジェクトにまとめる)
// 良い例
interface CreateProjectParams {
  name: string;
  address: string;
  surveyDate: Date;
  surveyorId: string;
}

function createProject(params: CreateProjectParams): Project {
  // ...
}

// ❌ 悪い例: 引数が多すぎる
function createProject(
  name: string,
  address: string,
  surveyDate: Date,
  surveyorId: string,
  status: string,
  notes: string
) {
  // ...
}

// ✅ 早期リターンでネストを減らす
function getUserName(userId: string): string | null {
  if (!userId) return null;

  const user = findUser(userId);
  if (!user) return null;

  return user.name;
}

// ❌ 悪い例: ネストが深い
function getUserName(userId: string): string | null {
  if (userId) {
    const user = findUser(userId);
    if (user) {
      return user.name;
    }
  }
  return null;
}
```

### 2.4 非同期処理

```typescript
// ✅ async/await を使用 (Promiseチェーンより読みやすい)
async function uploadPhoto(photo: Photo): Promise<UploadResult> {
  try {
    const compressed = await compressImage(photo);
    const uploaded = await uploadToCloud(compressed);
    const saved = await saveToDatabase(uploaded);
    return saved;
  } catch (error) {
    console.error('Photo upload failed:', error);
    throw error;
  }
}

// ✅ Promise.all で並列処理
async function uploadMultiplePhotos(photos: Photo[]): Promise<UploadResult[]> {
  return await Promise.all(
    photos.map(photo => uploadPhoto(photo))
  );
}

// ❌ 悪い例: Promiseチェーンは避ける
function uploadPhoto(photo: Photo): Promise<UploadResult> {
  return compressImage(photo)
    .then(compressed => uploadToCloud(compressed))
    .then(uploaded => saveToDatabase(uploaded))
    .catch(error => {
      console.error(error);
      throw error;
    });
}
```

### 2.5 エラーハンドリング

```typescript
// ✅ カスタムエラークラスを定義
class PhotoUploadError extends Error {
  constructor(
    message: string,
    public photoId: string,
    public originalError?: Error
  ) {
    super(message);
    this.name = 'PhotoUploadError';
  }
}

// ✅ 具体的なエラーメッセージ
if (!photo.latitude || !photo.longitude) {
  throw new Error('GPS位置情報が含まれていません');
}

// ✅ エラーをログに記録
try {
  await uploadPhoto(photo);
} catch (error) {
  console.error('写真アップロード失敗:', {
    photoId: photo.id,
    error: error.message,
    timestamp: new Date().toISOString()
  });
  throw error;
}

// ❌ 悪い例: エラーを無視
try {
  await uploadPhoto(photo);
} catch (error) {
  // 何もしない - これは避ける
}
```

---

## 3. React / React Native コーディング規約

### 3.1 コンポーネント構造

```typescript
// ✅ 関数コンポーネント + Hooks を使用
import React, { useState, useEffect } from 'react';
import { Photo } from '../types/photo.types';

interface PhotoCardProps {
  photo: Photo;
  onSelect: (photo: Photo) => void;
}

export function PhotoCard({ photo, onSelect }: PhotoCardProps) {
  const [isLoading, setIsLoading] = useState(false);

  useEffect(() => {
    // 副作用処理
  }, [photo.id]);

  const handleClick = () => {
    onSelect(photo);
  };

  return (
    <div className="photo-card" onClick={handleClick}>
      {/* JSX */}
    </div>
  );
}

// ❌ クラスコンポーネントは使わない (新規作成時)
class PhotoCard extends React.Component {
  // 既存コードでない限り避ける
}
```

### 3.2 Hooksのルール

```typescript
// ✅ カスタムHooksで共通ロジックを抽出
function usePhotoUpload() {
  const [uploading, setUploading] = useState(false);
  const [progress, setProgress] = useState(0);

  const upload = async (photo: Photo) => {
    setUploading(true);
    try {
      // アップロード処理
    } finally {
      setUploading(false);
    }
  };

  return { uploading, progress, upload };
}

// ✅ 使用例
function CameraScreen() {
  const { uploading, progress, upload } = usePhotoUpload();

  const handleCapture = async (photo: Photo) => {
    await upload(photo);
  };

  return (/* JSX */);
}

// ✅ useEffect の依存配列を正しく指定
useEffect(() => {
  fetchPhotos(projectId);
}, [projectId]); // projectIdが変更されたら再実行

// ❌ 悪い例: 依存配列を省略
useEffect(() => {
  fetchPhotos(projectId);
}); // 毎回実行される

// ❌ 悪い例: 空の依存配列で外部変数を使用
useEffect(() => {
  fetchPhotos(projectId); // projectIdが変更されても再実行されない
}, []);
```

### 3.3 条件付きレンダリング

```typescript
// ✅ 短絡評価を使う
{isLoading && <Loader />}
{error && <ErrorMessage error={error} />}

// ✅ 三項演算子
{photos.length > 0 ? (
  <PhotoList photos={photos} />
) : (
  <EmptyState message="写真がありません" />
)}

// ❌ 悪い例: if文は使えない
{if (isLoading) return <Loader />}  // エラー
```

### 3.4 スタイリング

```typescript
// ✅ CSS Modules または styled-components
import styles from './PhotoCard.module.css';

function PhotoCard() {
  return <div className={styles.card}>...</div>;
}

// または styled-components
import styled from 'styled-components';

const Card = styled.div`
  padding: 16px;
  border-radius: 8px;
  background-color: #fff;
`;

// ✅ React Native: StyleSheet を使用
import { StyleSheet } from 'react-native';

const styles = StyleSheet.create({
  container: {
    flex: 1,
    padding: 16,
  },
  text: {
    fontSize: 16,
    color: '#212121',
  },
});
```

---

## 4. ファイル・フォルダ構成

### 4.1 プロジェクト構造

```
phase1-mvp/
├── mobile-app/
│   ├── src/
│   │   ├── components/        # 共通コンポーネント
│   │   │   ├── Camera/
│   │   │   ├── PhotoCard/
│   │   │   └── Button/
│   │   ├── screens/           # 画面コンポーネント
│   │   │   ├── LoginScreen/
│   │   │   ├── CameraScreen/
│   │   │   └── PhotoListScreen/
│   │   ├── hooks/             # カスタムフック
│   │   ├── services/          # API通信、ビジネスロジック
│   │   ├── types/             # 型定義
│   │   ├── constants/         # 定数
│   │   ├── utils/             # ユーティリティ関数
│   │   └── styles/            # グローバルスタイル
│   ├── App.tsx
│   └── package.json
│
├── web-admin/
│   ├── src/
│   │   ├── components/
│   │   ├── pages/             # ページコンポーネント
│   │   ├── hooks/
│   │   ├── services/
│   │   ├── types/
│   │   ├── constants/
│   │   └── utils/
│   ├── public/
│   └── package.json
│
└── backend/
    ├── src/
    │   ├── controllers/       # リクエストハンドラ
    │   ├── services/          # ビジネスロジック
    │   ├── models/            # データモデル
    │   ├── routes/            # ルーティング
    │   ├── middleware/        # ミドルウェア
    │   ├── types/             # 型定義
    │   └── utils/             # ユーティリティ
    ├── tests/
    └── package.json
```

### 4.2 インポート順序

```typescript
// 1. 外部ライブラリ
import React, { useState } from 'react';
import { View, Text } from 'react-native';
import axios from 'axios';

// 2. 内部モジュール (絶対パス)
import { PhotoService } from '@/services/photoService';
import { Photo } from '@/types/photo.types';

// 3. 相対パス
import { Button } from '../components/Button';
import styles from './PhotoCard.module.css';

// 4. 型のみのインポート
import type { User } from '@/types/user.types';
```

---

## 5. コメント・ドキュメント

### 5.1 コメントのルール

```typescript
// ✅ 良いコメント: WHYを説明
// GPS精度が低い場合は地図の自動プロット位置がずれるため、
// 手動調整が必要になることをユーザーに通知する
if (accuracy > 50) {
  showAccuracyWarning();
}

// ✅ 複雑なロジックの説明
/**
 * 撮影方位(0-360度)を8方位(N, NE, E, SE, S, SW, W, NW)に変換
 * 例: 0度 → N, 45度 → NE, 90度 → E
 */
function directionToCompass(degrees: number): string {
  const directions = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'];
  const index = Math.round(degrees / 45) % 8;
  return directions[index];
}

// ❌ 悪いコメント: コードを繰り返すだけ
// ユーザー名を取得
const userName = user.name;  // 不要

// ✅ TODOコメント
// TODO: フェーズ2でAI画像解析を実装
// FIXME: iOS14でGPS精度が低い問題を修正
// NOTE: この処理は互換性のため残しているが、将来削除予定
```

### 5.2 JSDoc

```typescript
/**
 * 写真をクラウドにアップロードする
 *
 * @param photo - アップロードする写真オブジェクト
 * @param options - アップロードオプション
 * @returns アップロード結果
 * @throws {PhotoUploadError} アップロードに失敗した場合
 *
 * @example
 * ```typescript
 * const result = await uploadPhoto(photo, { compress: true });
 * console.log(result.url);
 * ```
 */
async function uploadPhoto(
  photo: Photo,
  options?: UploadOptions
): Promise<UploadResult> {
  // ...
}
```

---

## 6. テスト

### 6.1 テストの方針

```typescript
// ✅ ユニットテスト: ビジネスロジックをテスト
describe('directionToCompass', () => {
  it('0度はNを返す', () => {
    expect(directionToCompass(0)).toBe('N');
  });

  it('45度はNEを返す', () => {
    expect(directionToCompass(45)).toBe('NE');
  });

  it('360度はNを返す', () => {
    expect(directionToCompass(360)).toBe('N');
  });
});

// ✅ コンポーネントテスト
import { render, fireEvent } from '@testing-library/react';

describe('PhotoCard', () => {
  it('クリック時にonSelectが呼ばれる', () => {
    const mockOnSelect = jest.fn();
    const photo = { id: '1', /* ... */ };

    const { getByRole } = render(
      <PhotoCard photo={photo} onSelect={mockOnSelect} />
    );

    fireEvent.click(getByRole('button'));
    expect(mockOnSelect).toHaveBeenCalledWith(photo);
  });
});
```

---

## 7. Git コミットメッセージ

### 7.1 コミットメッセージ規約

```
<type>: <subject>

<body>

<footer>
```

**Type**:
- `feat`: 新機能
- `fix`: バグ修正
- `docs`: ドキュメント変更
- `style`: コードフォーマット変更 (機能変更なし)
- `refactor`: リファクタリング
- `test`: テスト追加・修正
- `chore`: ビルド・設定変更

**例**:
```
feat: GPS位置情報の自動記録機能を実装

写真撮影時にGPSから緯度・経度を自動取得し、
EXIFデータに埋め込む機能を追加。

関連: P1-M-001
```

---

## 8. セキュリティ

### 8.1 セキュリティのベストプラクティス

```typescript
// ✅ 環境変数で機密情報を管理
const API_KEY = process.env.REACT_APP_API_KEY;

// ❌ コードに直接書かない
const API_KEY = 'sk-1234567890abcdef';  // 絶対NG

// ✅ ユーザー入力をサニタイズ
import DOMPurify from 'dompurify';

function DisplayUserComment({ comment }: { comment: string }) {
  const sanitized = DOMPurify.sanitize(comment);
  return <div dangerouslySetInnerHTML={{ __html: sanitized }} />;
}

// ✅ SQLインジェクション対策 (プリペアードステートメント)
const result = await db.query(
  'SELECT * FROM photos WHERE project_id = $1',
  [projectId]
);

// ❌ 悪い例: 文字列連結
const result = await db.query(
  `SELECT * FROM photos WHERE project_id = '${projectId}'`  // SQLインジェクションの危険
);
```

---

## 9. パフォーマンス

### 9.1 パフォーマンスのベストプラクティス

```typescript
// ✅ React.memo でメモ化
export const PhotoCard = React.memo(({ photo, onSelect }: PhotoCardProps) => {
  // ...
});

// ✅ useMemo で重い計算をメモ化
const sortedPhotos = useMemo(
  () => photos.sort((a, b) => a.takenAt.getTime() - b.takenAt.getTime()),
  [photos]
);

// ✅ useCallback でコールバック関数をメモ化
const handleSelect = useCallback((photo: Photo) => {
  onSelect(photo);
}, [onSelect]);

// ✅ 画像の遅延読み込み
<img src={photo.url} loading="lazy" alt={photo.label} />

// ✅ 大量データは仮想スクロール
import { VirtualizedList } from 'react-native';
```

---

## 10. フェーズ別開発指針

### フェーズ1 (MVP)

- ✅ 基本機能を確実に動作させることを最優先
- ✅ パフォーマンス最適化は後回し (動作優先)
- ✅ テストは主要機能のみ
- ✅ コメントを多めに記載

### フェーズ2 (本システム)

- ✅ パフォーマンス最適化
- ✅ エッジケースの処理を追加
- ✅ テストカバレッジを80%以上
- ✅ ドキュメント整備

---

## 11. 改訂履歴

| 版数 | 改訂日 | 改訂内容 | 作成者 |
|------|--------|----------|--------|
| 1.0 | 2025-10-16 | 初版作成 | ミオシステム |
